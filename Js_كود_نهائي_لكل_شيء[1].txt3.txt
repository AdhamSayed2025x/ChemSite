/* ============ 1. INITIALIZATION & AUTH ============ */
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
let isAdmin = localStorage.getItem('isAdmin') === 'true';

// Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ)
let contentDB = JSON.parse(localStorage.getItem('chemSiteDB')) || [];

window.onload = function() {
    updateUI();         // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
    renderCards();      // Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„ÙƒØ±ÙˆØª)
    
    // Ù„Ùˆ Ø§Ø­Ù†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŒ Ø­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
    if(window.location.href.includes('profile.html')) {
        loadProfileData();
    }
};

/* ============ 2. UI & HEADER LOGIC ============ */
// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø£Ùˆ Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„)
function updateUI() {
    const headerActions = document.querySelector('.header-actions');
    const loginBtn = document.querySelector('.login-btn');

    // Ø´Ø±Ø· Ø£Ø³Ø§Ø³ÙŠ: Ù„Ø§Ø²Ù… Ù†ÙƒÙˆÙ† Ø£Ø¯Ù…Ù† ÙˆØ§Ù„ØµÙØ­Ø© ÙÙŠÙ‡Ø§ Ù‡ÙŠØ¯Ø±
    if (isAdmin && headerActions) {
        if (loginBtn) loginBtn.remove(); // Ø´ÙŠÙ„ Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„

        let profileImg = document.querySelector('.profile-img-btn');
        const savedImg = localStorage.getItem('profilePic') || "https://img.freepik.com/free-photo/portrait-white-man-isolated_53876-40306.jpg";

        if (!profileImg) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©
            const imgHTML = `
                <img src="${savedImg}" 
                     class="profile-img-btn" 
                     onclick="window.location.href='profile.html'"
                     title="Admin Profile"
                     style="width:45px; height:45px; border-radius:50%; border:2px solid var(--primary-color); cursor:pointer;">
            `;
            headerActions.insertAdjacentHTML('beforeend', imgHTML);
        } else {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©
            profileImg.src = savedImg;
            profileImg.onclick = function() { window.location.href = 'profile.html'; };
            profileImg.style.cursor = "pointer";
        }
    }
}

/* ============ 3. CONTENT SYSTEM (RENDER & CARDS) ============ */
// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„ÙƒØ±ÙˆØª (Ø§Ù„ÙˆØ­Ø´ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
function renderCards() {
    const grid = document.querySelector('.items-grid');
    const emptyMsg = document.getElementById('emptyMsg');
    
    if (!grid) return; // Ù„Ùˆ Ù…ÙÙŠØ´ Ø´Ø¨ÙƒØ© (Ø²ÙŠ ØµÙØ­Ø© Ø§Ù„Ù„ÙˆØ¬ÙŠÙ†) Ø§Ø®Ø±Ø¬

    grid.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const pageName = new URLSearchParams(window.location.search).get('page') || 'General';

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
    const pageContent = contentDB.filter(item => item.page === pageName);

    if (pageContent.length === 0) {
        if(emptyMsg) emptyMsg.style.display = 'block';
    } else {
        if(emptyMsg) emptyMsg.style.display = 'none';
        
        pageContent.forEach(item => {
            // Ù„Ùˆ Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ù…Ù„Ù Ù…Ø®ÙÙŠ -> Ù…ØªØ±Ø³Ù…ÙˆØ´
            if (!isAdmin && !item.permissions.visible) return;

            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            const dateStr = new Date(item.timestamp).toLocaleString('en-GB', { hour12: true });
            
            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Dropdown)
            let menuItems = '';
            
            // Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (Ù„Ù„Ø¬Ù…ÙŠØ¹)
            menuItems += `<div class="menu-item" onclick="openViewer('${item.id}')"><i class="fa-solid fa-eye"></i> View</div>`;

            // Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù„Ùˆ Ù…Ø³Ù…ÙˆØ­ Ø£Ùˆ Ø£Ø¯Ù…Ù†)
            if (isAdmin || item.permissions.download) {
                menuItems += `<div class="menu-item" onclick="downloadFile('${item.link}')"><i class="fa-solid fa-download"></i> Download</div>`;
            }

            // Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ù„Ùˆ Ù…Ø³Ù…ÙˆØ­ Ø£Ùˆ Ø£Ø¯Ù…Ù†)
            if (isAdmin || item.permissions.share) {
                menuItems += `<div class="menu-item" onclick="shareFile('${item.title}', '${item.link}')"><i class="fa-solid fa-share-nodes"></i> Share</div>`;
            }

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù)
            if (isAdmin) {
                menuItems += `<div class="menu-item" onclick="editContent('${item.id}')"><i class="fa-solid fa-pen"></i> Edit</div>`;
                menuItems += `<div class="menu-item delete" onclick="deleteContent('${item.id}')"><i class="fa-solid fa-trash"></i> Delete</div>`;
            }

            // Ø±Ø³Ù… Ø§Ù„ÙƒØ§Ø±Øª
            const cardHTML = `
                <div class="content-card">
                    <div class="card-menu-btn" onclick="toggleMenu(this, event)">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </div>
                    <div class="card-menu-dropdown">${menuItems}</div>

                    <div class="card-icon"><i class="fa-solid ${getIconByType(item.type)}"></i></div>
                    <div class="card-meta">${dateStr}</div>
                    
                    <h3 class="card-title">${item.title}</h3>
                    <p class="card-desc">${item.desc}</p>
                    
                    <div class="card-actions">
                        <button class="action-btn btn-view" onclick="openViewer('${item.id}')">Open File</button>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('afterbegin', cardHTML);
        });
    }
}

/* ============ 4. ADMIN ACTIONS (ADD / EDIT / DELETE) ============ */
// ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„Ø¥Ø¶Ø§ÙØ©
function openUploadModal() {
    document.getElementById('uploadModal').classList.add('active');
    document.getElementById('modalTitle').innerText = "Add New Content";
    document.getElementById('editContentId').value = ""; // ÙØ¶ÙŠ Ø§Ù„Ù…Ø¹Ø±Ù
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø®Ø§Ù†Ø§Øª
    document.getElementById('contentTitle').value = "";
    document.getElementById('contentDesc').value = "";
    document.getElementById('contentLink').value = "";
    document.getElementById('contentType').value = "pdf";
    toggleSourceInput();
    
    // ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
    const fabMenu = document.getElementById('fabMenu');
    if(fabMenu) { fabMenu.classList.remove('show'); document.querySelector('.fab-main-btn').classList.remove('active'); }
}

// ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function editContent(id) {
    const item = contentDB.find(c => c.id == id);
    if (!item) return;

    document.getElementById('uploadModal').classList.add('active');
    document.getElementById('modalTitle').innerText = "Edit Content";
    document.getElementById('editContentId').value = item.id;
    
    document.getElementById('contentTitle').value = item.title;
    document.getElementById('contentDesc').value = item.desc;
    document.getElementById('contentType').value = item.type;
    document.getElementById('contentLink').value = item.link;
    
    // Ø¶Ø¨Ø· Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    document.getElementById('allowDownload').checked = item.permissions.download;
    document.getElementById('allowShare').checked = item.permissions.share;
    document.getElementById('isVisible').checked = item.permissions.visible;
    
    toggleSourceInput();
}

// Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
function saveContent() {
    const id = document.getElementById('editContentId').value;
    const title = document.getElementById('contentTitle').value;
    const desc = document.getElementById('contentDesc').value;
    const type = document.getElementById('contentType').value;
    const link = document.getElementById('contentLink').value;
    
    const permissions = {
        download: document.getElementById('allowDownload').checked,
        share: document.getElementById('allowShare').checked,
        visible: document.getElementById('isVisible').checked
    };

    if (!title) return alert("Title is required!");

    if (id) {
        // ØªØ¹Ø¯ÙŠÙ„
        const index = contentDB.findIndex(c => c.id == id);
        if (index !== -1) {
            contentDB[index] = { ...contentDB[index], title, desc, type, link, permissions };
        }
    } else {
        // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
        const newItem = {
            id: Date.now(),
            page: new URLSearchParams(window.location.search).get('page') || 'General',
            title, desc, type, link, permissions,
            timestamp: new Date().toISOString()
        };
        contentDB.push(newItem);
    }

    localStorage.setItem('chemSiteDB', JSON.stringify(contentDB));
    renderCards();
    closeModal();
}

// Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰
function deleteContent(id) {
    if(confirm("Delete this content permanently?")) {
        contentDB = contentDB.filter(c => c.id != id);
        localStorage.setItem('chemSiteDB', JSON.stringify(contentDB));
        renderCards();
    }
}

// ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function closeModal() {
    document.getElementById('uploadModal').classList.remove('active');
}

/* ============ 5. UTILS & VIEWER & CAMERA ============ */
// ØªØºÙŠÙŠØ± Ø­Ù‚Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
function toggleSourceInput() {
    const type = document.getElementById('contentType').value;
    const container = document.getElementById('sourceInputContainer');
    const input = document.getElementById('contentLink');
    const camInput = document.getElementById('cameraInput');

    if (type === 'camera') {
        container.style.display = 'none';
        camInput.click();
    } else if (type === 'drive') {
        container.style.display = 'block';
        input.placeholder = "Paste Google Drive Link...";
    } else {
        container.style.display = 'block';
        input.placeholder = "Paste Link here...";
    }
}

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
function handleCamera(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('contentLink').value = e.target.result;
            document.getElementById('sourceInputContainer').style.display = 'none';
            alert("Photo captured! ğŸ“¸");
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// ÙØªØ­ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ (Viewer)
function openViewer(id) {
    const item = contentDB.find(c => c.id == id);
    if (!item) return;

    const viewer = document.getElementById('fileViewer');
    const frame = document.getElementById('viewerFrame');
    const img = document.getElementById('viewerImage');
    const title = document.getElementById('viewerTitle');

    title.innerText = item.title;
    viewer.classList.add('active');

    // Ù„Ùˆ ØµÙˆØ±Ø©
    if (item.type === 'camera' || item.link.startsWith('data:image')) {
        frame.style.display = 'none';
        img.style.display = 'block';
        img.src = item.link;
    } else {
        // Ù„Ùˆ Ù…Ù„Ù/ÙÙŠØ¯ÙŠÙˆ
        img.style.display = 'none';
        frame.style.display = 'block';
        let url = item.link;
        if(url.includes('youtube.com/watch?v=')) url = url.replace('watch?v=', 'embed/');
        if(url.includes('drive.google.com') && url.includes('/view')) url = url.replace('/view', '/preview');
        frame.src = url;
    }
}

function closeViewer() {
    document.getElementById('fileViewer').classList.remove('active');
    document.getElementById('viewerFrame').src = "";
}

// Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function toggleMenu(btn, e) {
    e.stopPropagation();
    document.querySelectorAll('.card-menu-dropdown').forEach(m => m.classList.remove('show'));
    btn.nextElementSibling.classList.toggle('show');
}

window.addEventListener('click', () => {
    document.querySelectorAll('.card-menu-dropdown').forEach(m => m.classList.remove('show'));
});

// Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
function getIconByType(type) {
    if(type === 'video') return 'fa-video';
    if(type === 'pdf') return 'fa-file-pdf';
    if(type === 'drive') return 'fa-google-drive';
    if(type === 'camera') return 'fa-camera';
    return 'fa-link';
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
function downloadFile(link) {
    if(link.startsWith('data:')) {
        const a = document.createElement('a');
        a.href = link;
        a.download = "downloaded_file.jpg";
        a.click();
    } else {
        window.open(link, '_blank');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
function shareFile(title, link) {
    if(navigator.share) {
        navigator.share({ title: title, url: link });
    } else {
        prompt("Copy this link:", link);
    }
}

/* ============ 6. LOGIN & NAVIGATION & PROFILE ============ */
function showComingSoon(featureName) {
    if (featureName === 'Login Page') {
        window.location.href = 'login.html';
        return;
    }
    if (isAdmin) {
        window.location.href = `admin_page.html?page=${featureName}`;
    } else {
        window.location.href = `soon.html?page=${featureName}`;
    }
}

function performLogin() {
    const email = document.getElementById('emailInput').value;
    const pass = document.getElementById('passInput').value;
    
    // Login Logic
    if ((email === "Adham" || email === "Adham@Vision.Bim") && pass === "123") {
        document.getElementById('successOverlay').classList.add('active');
        localStorage.setItem('isAdmin', 'true');
        setTimeout(() => window.location.href = "index.html", 2000);
    } else {
        document.getElementById('emailError').classList.add('visible'); // Simple Error
    }
}

function logoutUser() {
    if(confirm("Are you sure you want to log out?")) {
        localStorage.removeItem('isAdmin');
        window.location.href = "index.html";
    }
}

function toggleFab() {
    document.getElementById('fabMenu').classList.toggle('show');
    document.querySelector('.fab-main-btn').classList.toggle('active');
}

// Profile Page Logic
function triggerCamera() { document.getElementById('fileUpload').click(); }
function saveProfileImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profileImage').src = e.target.result;
            localStorage.setItem('profilePic', e.target.result);
        }
        reader.readAsDataURL(input.files[0]);
    }
}
function editField(id, label) {
    const el = document.getElementById(id);
    const val = prompt(`Enter new ${label}:`, el.innerText);
    if(val) { el.innerText = val; localStorage.setItem(id, val); }
}
function loadProfileData() {
    const img = localStorage.getItem('profilePic');
    if(img) document.getElementById('profileImage').src = img;
    const name = localStorage.getItem('profileNameDisplay');
    if(name) document.getElementById('profileNameDisplay').innerText = name;
    const about = localStorage.getItem('profileAboutDisplay');
    if(about) document.getElementById('profileAboutDisplay').innerText = about;
}

// Login Helper
function togglePassword() {
    const pass = document.getElementById('passInput');
    pass.type = pass.type === 'password' ? 'text' : 'password';
}
function clearError(id) { document.getElementById(id).classList.remove('visible'); }